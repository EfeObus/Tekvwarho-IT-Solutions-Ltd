<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics | Tekvwarho Admin</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Tekvwarho</h2>
                <span class="subtitle">Admin Dashboard</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <span class="nav-section-title">Main</span>
                    <a href="index.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        Dashboard
                    </a>
                    <a href="messages.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        Messages
                        <span class="badge" id="messages-badge">0</span>
                    </a>
                    <a href="chats.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Live Chats
                        <span class="badge" id="chats-badge">0</span>
                    </a>
                    <a href="consultations.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Consultations
                    </a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">Management</span>
                    <a href="staff.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        Staff
                    </a>
                    <a href="analytics.html" class="nav-item active">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        Analytics
                    </a>
                    <a href="performance.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="23" y1="6" x2="17" y2="12"></line>
                            <line x1="17" y1="12" x2="12" y2="9"></line>
                            <line x1="12" y1="9" x2="1" y2="18"></line>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        Performance
                    </a>
                    <a href="audit.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Audit Logs
                    </a>
                </div>
                <div class="nav-section">
                    <span class="nav-section-title">Settings</span>
                    <a href="settings.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                        Settings
                    </a>
                    <a href="../index.html" class="nav-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        View Website
                    </a>
                    <a href="#" class="nav-item" id="logout-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Logout
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <button class="sidebar-toggle" id="sidebar-toggle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <h1 class="page-title">Advanced Analytics</h1>
                </div>
                <div class="header-right">
                    <div class="filter-group">
                        <label>Period:</label>
                        <select id="period-filter">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                    <div class="realtime-indicator">
                        <span class="pulse-dot"></span>
                        <span id="active-visitors">0</span> active now
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="admin-content">
                <!-- Real-time Stats Row -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-visitors">0</h3>
                            <p>Unique Visitors</p>
                            <span class="stat-change positive" id="visitor-change">+0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-pageviews">0</h3>
                            <p>Page Views</p>
                            <span class="stat-change positive" id="pageview-change">+0%</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-sessions">0</h3>
                            <p>Avg. Pages/Session</p>
                            <span class="stat-change neutral">-</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <h3 id="stat-conversions">0</h3>
                            <p>Conversions</p>
                            <span class="stat-change positive">-</span>
                        </div>
                    </div>
                </div>

                <!-- Traffic Chart -->
                <div class="card">
                    <div class="card-header">
                        <h3>Traffic Overview</h3>
                        <div class="chart-legend">
                            <span class="legend-item"><span class="legend-dot blue"></span> Page Views</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="traffic-chart" height="300"></canvas>
                    </div>
                </div>

                <!-- Two Column Charts -->
                <div class="charts-grid">
                    <!-- Traffic Sources -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Traffic Sources</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="sources-chart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Device Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Devices</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="devices-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Pages & Hourly Traffic -->
                <div class="charts-grid">
                    <!-- Top Pages -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Top Pages</h3>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Page</th>
                                        <th>Views</th>
                                        <th>Unique</th>
                                    </tr>
                                </thead>
                                <tbody id="top-pages-tbody">
                                    <tr>
                                        <td colspan="3" class="text-center text-muted" style="padding: 20px;">
                                            Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Hourly Traffic -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Traffic by Hour</h3>
                        </div>
                        <div class="card-body">
                            <canvas id="hourly-chart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Business Metrics -->
                <div class="charts-grid">
                    <!-- Messages by Service -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Messages by Service</h3>
                        </div>
                        <div class="card-body">
                            <div id="services-breakdown">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Lead Status Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Lead Status Breakdown</h3>
                        </div>
                        <div class="card-body">
                            <div id="status-breakdown">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Visitor Types -->
                <div class="card">
                    <div class="card-header">
                        <h3>Visitor Types</h3>
                    </div>
                    <div class="card-body">
                        <div class="visitor-types-grid">
                            <div class="visitor-type new-visitors">
                                <div class="type-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="8.5" cy="7" r="4"></circle>
                                        <line x1="20" y1="8" x2="20" y2="14"></line>
                                        <line x1="23" y1="11" x2="17" y2="11"></line>
                                    </svg>
                                </div>
                                <div class="type-info">
                                    <h4 id="new-visitors-count">0</h4>
                                    <p>New Visitors</p>
                                </div>
                            </div>
                            <div class="visitor-type returning-visitors">
                                <div class="type-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                    </svg>
                                </div>
                                <div class="type-info">
                                    <h4 id="returning-visitors-count">0</h4>
                                    <p>Returning Visitors</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>Type</th>
                                        <th>Details</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody id="activity-tbody">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted" style="padding: 40px;">
                                            Loading activity...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #e8f5e9;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: #2e7d32;
        }
        
        .pulse-dot {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-legend {
            display: flex;
            gap: 16px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .legend-dot.blue { background: #0066CC; }
        .legend-dot.green { background: #28a745; }
        
        .stat-change {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .stat-change.positive {
            color: #28a745;
            background: #e8f5e9;
        }
        
        .stat-change.negative {
            color: #dc3545;
            background: #ffebee;
        }
        
        .stat-change.neutral {
            color: #666;
            background: #f5f5f5;
        }
        
        .breakdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .breakdown-label {
            width: 120px;
            font-size: 13px;
            color: #555;
        }
        
        .breakdown-bar {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .breakdown-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        
        .breakdown-fill.blue { background: linear-gradient(90deg, #0066CC, #0099ff); }
        .breakdown-fill.green { background: linear-gradient(90deg, #28a745, #20c997); }
        .breakdown-fill.orange { background: linear-gradient(90deg, #fd7e14, #ffc107); }
        .breakdown-fill.purple { background: linear-gradient(90deg, #6f42c1, #e83e8c); }
        .breakdown-fill.gray { background: linear-gradient(90deg, #6c757d, #adb5bd); }
        
        .breakdown-value {
            width: 50px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }
        
        .visitor-types-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .visitor-type {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-radius: 12px;
            background: #f8f9fa;
        }
        
        .visitor-type.new-visitors {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .visitor-type.returning-visitors {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .type-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .type-icon svg {
            width: 24px;
            height: 24px;
            stroke: #0066CC;
        }
        
        .returning-visitors .type-icon svg {
            stroke: #28a745;
        }
        
        .type-info h4 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: #333;
        }
        
        .type-info p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .realtime-indicator {
                display: none;
            }
        }
    </style>

    <script src="js/admin.js"></script>
    <script>
        // Charts instances
        let trafficChart, sourcesChart, devicesChart, hourlyChart;
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            // Initialize sidebar
            initSidebar();
            
            // Load analytics
            loadAnalytics();
            loadRealtime();
            
            // Period filter change
            document.getElementById('period-filter').addEventListener('change', () => {
                loadAnalytics();
            });
            
            // Refresh realtime every 30 seconds
            setInterval(loadRealtime, 30000);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminUser');
                window.location.href = 'login.html';
            });
        });
        
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            sidebarToggle?.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            });
            
            sidebarOverlay?.addEventListener('click', () => {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
        }
        
        async function loadAnalytics() {
            const period = document.getElementById('period-filter').value;
            const token = localStorage.getItem('adminToken');
            
            try {
                const response = await fetch(`/api/analytics?period=${period}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStats(result.data.summary);
                    updateTrafficChart(result.data.pageViews);
                    updateSourcesChart(result.data.trafficSources);
                    updateDevicesChart(result.data.devices);
                    updateHourlyChart(result.data.hourlyTraffic);
                    updateTopPages(result.data.topPages);
                    updateServicesBreakdown(result.data.serviceMessages);
                    updateStatusBreakdown(result.data.messageStatus);
                    updateVisitorTypes(result.data.visitorTypes);
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
            
            // Also load summary for recent activity
            loadSummary();
        }
        
        async function loadSummary() {
            const token = localStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/api/analytics/summary', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateRecentActivity(result.data.recentActivity);
                }
            } catch (error) {
                console.error('Failed to load summary:', error);
            }
        }
        
        async function loadRealtime() {
            const token = localStorage.getItem('adminToken');
            
            try {
                const response = await fetch('/api/analytics/realtime', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('active-visitors').textContent = result.data.activeVisitors;
                }
            } catch (error) {
                console.error('Failed to load realtime:', error);
            }
        }
        
        function updateStats(summary) {
            document.getElementById('stat-visitors').textContent = summary.uniqueVisitors.toLocaleString();
            document.getElementById('stat-pageviews').textContent = summary.totalPageViews.toLocaleString();
            document.getElementById('stat-sessions').textContent = summary.avgPagesPerSession;
            document.getElementById('stat-conversions').textContent = summary.conversions.toLocaleString();
            
            // Update change indicators
            const visitorChange = document.getElementById('visitor-change');
            visitorChange.textContent = `${summary.visitorChange >= 0 ? '+' : ''}${summary.visitorChange}%`;
            visitorChange.className = `stat-change ${summary.visitorChange >= 0 ? 'positive' : 'negative'}`;
            
            const pageviewChange = document.getElementById('pageview-change');
            pageviewChange.textContent = `${summary.pageViewChange >= 0 ? '+' : ''}${summary.pageViewChange}%`;
            pageviewChange.className = `stat-change ${summary.pageViewChange >= 0 ? 'positive' : 'negative'}`;
        }
        
        function updateTrafficChart(pageViews) {
            const ctx = document.getElementById('traffic-chart').getContext('2d');
            
            const labels = pageViews.map(pv => {
                const date = new Date(pv.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            
            const data = pageViews.map(pv => parseInt(pv.count));
            
            if (trafficChart) {
                trafficChart.destroy();
            }
            
            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Page Views',
                        data: data,
                        borderColor: '#0066CC',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function updateSourcesChart(sources) {
            const ctx = document.getElementById('sources-chart').getContext('2d');
            
            const colors = ['#0066CC', '#28a745', '#fd7e14', '#6f42c1', '#20c997', '#e83e8c'];
            
            if (sourcesChart) {
                sourcesChart.destroy();
            }
            
            sourcesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sources.map(s => s.source),
                    datasets: [{
                        data: sources.map(s => parseInt(s.count)),
                        backgroundColor: colors.slice(0, sources.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { padding: 20 }
                        }
                    }
                }
            });
        }
        
        function updateDevicesChart(devices) {
            const ctx = document.getElementById('devices-chart').getContext('2d');
            
            const colorMap = {
                'Desktop': '#0066CC',
                'Mobile': '#28a745',
                'Tablet': '#fd7e14'
            };
            
            if (devicesChart) {
                devicesChart.destroy();
            }
            
            devicesChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: devices.map(d => d.device_type),
                    datasets: [{
                        data: devices.map(d => parseInt(d.count)),
                        backgroundColor: devices.map(d => colorMap[d.device_type] || '#6c757d'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { padding: 20 }
                        }
                    }
                }
            });
        }
        
        function updateHourlyChart(hourlyData) {
            const ctx = document.getElementById('hourly-chart').getContext('2d');
            
            // Create full 24 hour labels
            const labels = Array.from({ length: 24 }, (_, i) => {
                const hour = i % 12 || 12;
                const ampm = i < 12 ? 'AM' : 'PM';
                return `${hour}${ampm}`;
            });
            
            // Map data to hours
            const data = Array(24).fill(0);
            hourlyData.forEach(h => {
                data[parseInt(h.hour)] = parseInt(h.count);
            });
            
            if (hourlyChart) {
                hourlyChart.destroy();
            }
            
            hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Page Views',
                        data: data,
                        backgroundColor: 'rgba(0, 102, 204, 0.7)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        function updateTopPages(pages) {
            const tbody = document.getElementById('top-pages-tbody');
            
            if (pages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted" style="padding: 20px;">
                            No page data available
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pages.map(page => {
                const pageName = page.page_url.split('/').pop() || 'Home';
                return `
                    <tr>
                        <td title="${page.page_url}">${pageName}</td>
                        <td>${parseInt(page.count).toLocaleString()}</td>
                        <td>${parseInt(page.unique_visitors).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateServicesBreakdown(services) {
            const container = document.getElementById('services-breakdown');
            
            if (!services || services.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No service data available</p>';
                return;
            }
            
            const total = services.reduce((sum, s) => sum + parseInt(s.count), 0);
            const colors = ['blue', 'green', 'orange', 'purple', 'gray'];
            
            container.innerHTML = services.map((service, i) => {
                const percentage = total > 0 ? (parseInt(service.count) / total * 100).toFixed(1) : 0;
                return `
                    <div class="breakdown-item">
                        <span class="breakdown-label">${service.service}</span>
                        <div class="breakdown-bar">
                            <div class="breakdown-fill ${colors[i % colors.length]}" style="width: ${percentage}%"></div>
                        </div>
                        <span class="breakdown-value">${service.count}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateStatusBreakdown(statuses) {
            const container = document.getElementById('status-breakdown');
            
            if (!statuses || statuses.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No status data available</p>';
                return;
            }
            
            const total = statuses.reduce((sum, s) => sum + parseInt(s.count), 0);
            const colorMap = {
                'new': 'blue',
                'in_progress': 'orange',
                'converted': 'green',
                'archived': 'gray'
            };
            
            container.innerHTML = statuses.map(status => {
                const percentage = total > 0 ? (parseInt(status.count) / total * 100).toFixed(1) : 0;
                const color = colorMap[status.status] || 'gray';
                const label = status.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                return `
                    <div class="breakdown-item">
                        <span class="breakdown-label">${label}</span>
                        <div class="breakdown-bar">
                            <div class="breakdown-fill ${color}" style="width: ${percentage}%"></div>
                        </div>
                        <span class="breakdown-value">${status.count}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateVisitorTypes(types) {
            const newCount = types.find(t => t.visitor_type === 'New')?.count || 0;
            const returningCount = types.find(t => t.visitor_type === 'Returning')?.count || 0;
            
            document.getElementById('new-visitors-count').textContent = parseInt(newCount).toLocaleString();
            document.getElementById('returning-visitors-count').textContent = parseInt(returningCount).toLocaleString();
        }
        
        function updateRecentActivity(activities) {
            const tbody = document.getElementById('activity-tbody');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted" style="padding: 40px;">
                            No recent activity
                        </td>
                    </tr>
                `;
                return;
            }
            
            const typeIcons = {
                'message': 'ðŸ“§',
                'consultation': 'ðŸ“…',
                'chat': 'ðŸ’¬'
            };
            
            const typeColors = {
                'message': '#0066CC',
                'consultation': '#28a745',
                'chat': '#fd7e14'
            };
            
            tbody.innerHTML = activities.map(activity => {
                const date = new Date(activity.created_at);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <tr>
                        <td>${typeIcons[activity.type] || 'ðŸ“Œ'} ${activity.title}</td>
                        <td><span class="status-badge" style="background: ${typeColors[activity.type]}20; color: ${typeColors[activity.type]}">${activity.type}</span></td>
                        <td>${activity.details || '-'}</td>
                        <td>${formattedDate}</td>
                    </tr>
                `;
            }).join('');
        }
    </script>
</body>
</html>
